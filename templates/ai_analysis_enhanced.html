<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n t√≠ch AI n√¢ng cao - {{ product.product_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .ai-content {
            background: white;
            color: #333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            line-height: 1.6;
        }
        .standards-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .standards-item.missing {
            border-left-color: #dc3545;
        }
        .standards-item.partial {
            border-left-color: #ffc107;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .enhancement-badge {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .ai-unavailable {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="{{ url_for('main.index') }}" class="navbar-brand">üå± Truy xu·∫•t Ngu·ªìn g·ªëc</a>
            <div class="navbar-actions">
                {% if user %}
                    <a href="{{ url_for('products.manage') }}" class="btn btn-secondary btn-small">Qu·∫£n l√Ω</a>
                    {% if user.role == 'admin' %}
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary btn-small">Admin</a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-secondary btn-small">ƒêƒÉng xu·∫•t</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-robot text-primary"></i> Ph√¢n t√≠ch AI n√¢ng cao</h2>
                        <p class="text-muted">S·∫£n ph·∫©m: <strong>{{ product.product_name }}</strong></p>
                    </div>
                    <div>
                        {% if analysis.ai_enhanced %}
                            <span class="enhancement-badge">
                                <i class="fas fa-brain"></i> AI Enhanced
                            </span>
                        {% endif %}
                        <a href="{{ url_for('products.product', product_id=product.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left"></i> Quay l·∫°i
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ph√¢n t√≠ch c∆° b·∫£n -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-4 text-primary">{{ analysis.score }}</div>
                        <h5>ƒêi·ªÉm minh b·∫°ch</h5>
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ analysis.score }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-4 text-success">{{ analysis.standards_compliance.compliance_score }}</div>
                        <h5>Tu√¢n th·ªß ti√™u chu·∫©n</h5>
                        <p class="text-muted">{{ analysis.standards_compliance.compliance_level }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-4 text-info">{{ analysis.stats.production_media_count + analysis.stats.harvest_media_count }}</div>
                        <h5>Media files</h5>
                        <p class="text-muted">H√¨nh ·∫£nh & Video</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ph√¢n t√≠ch OpenAI -->
        {% if analysis.ai_enhanced %}
        <div class="ai-section">
            <h3><i class="fas fa-brain"></i> Ph√¢n t√≠ch AI chi ti·∫øt</h3>
            <p>ƒê∆∞·ª£c t·∫°o b·ªüi OpenAI GPT v√†o {{ analysis.openai_timestamp }}</p>
            <div class="ai-content">
                {{ analysis.openai_suggestions | replace('\n', '<br>') | safe }}
            </div>
        </div>
        {% elif analysis.get('openai_error') %}
        <div class="ai-unavailable">
            <h5><i class="fas fa-exclamation-triangle"></i> T√≠nh nƒÉng AI t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng</h5>
            <p><strong>L√Ω do:</strong> ƒêang c·∫≠p nh·∫≠t h·ªá th·ªëng AI ho·∫∑c v∆∞·ª£t qu√° gi·ªõi h·∫°n s·ª≠ d·ª•ng.</p>
            <p><strong>Gi·∫£i ph√°p:</strong> Hi·ªÉn th·ªã ph√¢n t√≠ch c∆° b·∫£n thay th·∫ø. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i>
                <strong>Th√¥ng tin:</strong> T√≠nh nƒÉng AI Analysis s·∫Ω ho·∫°t ƒë·ªông tr·ªü l·∫°i sau khi ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
            </div>
        </div>
        {% else %}
        <div class="ai-unavailable">
            <h5><i class="fas fa-info-circle"></i> T√≠nh nƒÉng AI Analysis t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng</h5>
            <p><strong>Tr·∫°ng th√°i:</strong> ƒêang b·∫£o tr√¨ ho·∫∑c c·∫≠p nh·∫≠t h·ªá th·ªëng AI.</p>
            <p><strong>Thay th·∫ø:</strong> Hi·ªÉn th·ªã ph√¢n t√≠ch c∆° b·∫£n d·ª±a tr√™n thu·∫≠t to√°n n·ªôi b·ªô.</p>
            <div class="alert alert-success mt-3">
                <i class="fas fa-lightbulb"></i>
                <strong>G·ª£i √Ω:</strong> B·∫°n v·∫´n c√≥ th·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng "AI Report c∆° b·∫£n" ƒë·ªÉ c√≥ ph√¢n t√≠ch s·∫£n ph·∫©m.
            </div>
        </div>
        {% endif %}

        <!-- G·ª£i √Ω ti√™u chu·∫©n s·ªë h√≥a -->
        <div class="ai-section">
            <h3><i class="fas fa-clipboard-check"></i> Ti√™u chu·∫©n s·ªë h√≥a</h3>
            {% if standards_suggestions.available and standards_suggestions.suggestions %}
                <div class="ai-content">
                    {% for standard in standards_suggestions.suggestions %}
                        <div class="standards-item {% if standard.status == 'complete' %}{% elif standard.status == 'partial' %}partial{% else %}missing{% endif %} mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="fas fa-{% if standard.status == 'complete' %}check-circle text-success{% elif standard.status == 'partial' %}exclamation-circle text-warning{% else %}times-circle text-danger{% endif %} me-2"></i>
                                        {{ standard.name }}
                                    </h6>
                                    <p class="mb-0 text-muted">{{ standard.description }}</p>
                                </div>
                                <span class="badge bg-{% if standard.status == 'complete' %}success{% elif standard.status == 'partial' %}warning{% else %}danger{% endif %}">
                                    {% if standard.status == 'complete' %}Ho√†n th√†nh{% elif standard.status == 'partial' %}M·ªôt ph·∫ßn{% else %}Thi·∫øu{% endif %}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="ai-content">
                    <p>G·ª£i √Ω ti√™u chu·∫©n s·ªë h√≥a kh√¥ng kh·∫£ d·ª•ng. C·∫ßn c·∫•u h√¨nh OpenAI API.</p>
                </div>
            {% endif %}
        </div>

        <!-- Ph√¢n t√≠ch th·ªã tr∆∞·ªùng -->
        <div class="ai-section">
            <h3><i class="fas fa-chart-line"></i> Ph√¢n t√≠ch th·ªã tr∆∞·ªùng</h3>
            {% if market_analysis.available and market_analysis.analysis %}
                <div class="ai-content">
                    {% set market = market_analysis.analysis %}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-bullseye"></i> Ti·ªÅm nƒÉng th·ªã tr∆∞·ªùng</h6>
                            <span class="badge bg-success fs-6">{{ market.market_potential }}</span>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-dollar-sign"></i> M·ª©c gi√°</h6>
                            <span class="badge bg-info fs-6">{{ market.price_range }}</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-users"></i> ƒê·ªëi t∆∞·ª£ng kh√°ch h√†ng</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for customer in market.target_customers %}
                                <span class="badge bg-primary">{{ customer }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-store"></i> K√™nh ph√¢n ph·ªëi</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for channel in market.distribution_channels %}
                                <span class="badge bg-secondary">{{ channel }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-star"></i> L·ª£i th·∫ø c·∫°nh tranh</h6>
                        <p class="text-success fw-bold">{{ market.competitive_advantage }}</p>
                    </div>

                    <div class="mb-4">
                        <h6><i class="fas fa-lightbulb"></i> G·ª£i √Ω Marketing</h6>
                        <ul class="list-group list-group-flush">
                            {% for suggestion in market.marketing_suggestions %}
                                <li class="list-group-item border-0 px-0">
                                    <i class="fas fa-check-circle text-success me-2"></i>{{ suggestion }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% else %}
                <div class="ai-content">
                    <h5>G·ª£i √Ω th·ªã tr∆∞·ªùng c∆° b·∫£n:</h5>
                    {% for suggestion in analysis.market_suggestions %}
                    <div class="mb-3">
                        <h6>{{ suggestion.type }}</h6>
                        <p>{{ suggestion.suggestion }}</p>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- K·∫ø ho·∫°ch c·∫£i thi·ªán -->
        <div class="ai-section">
            <h3><i class="fas fa-tasks"></i> K·∫ø ho·∫°ch c·∫£i thi·ªán</h3>
            {% if improvement_plan.available and improvement_plan.plan %}
                <div class="ai-content">
                    {% for plan in improvement_plan.plan %}
                        <div class="card mb-3 border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-tasks me-2"></i>{{ plan.action }}
                                    </h6>
                                    <span class="badge bg-{% if plan.priority == 'Cao' %}danger{% elif plan.priority == 'Trung b√¨nh' %}warning{% else %}secondary{% endif %}">
                                        {{ plan.priority }}
                                    </span>
                                </div>
                                <p class="card-text text-muted mb-2">{{ plan.description }}</p>
                                <small class="text-info">
                                    <i class="fas fa-clock me-1"></i>Th·ªùi gian: {{ plan.timeline }}
                                </small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="ai-content">
                    <h5>G·ª£i √Ω c·∫£i thi·ªán c∆° b·∫£n:</h5>
                    <ul>
                        {% for rec in analysis.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>

        <!-- N√∫t h√†nh ƒë·ªông -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="{{ url_for('products.digitization_guide') }}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-book"></i> H∆∞·ªõng d·∫´n s·ªë h√≥a
                </a>
                <a href="{{ url_for('products.edit_product', product_id=product.id) }}" class="btn btn-success btn-lg">
                    <i class="fas fa-edit"></i> C·∫£i thi·ªán s·∫£n ph·∫©m
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh AI suggestions every 30 seconds if available
        {% if analysis.ai_enhanced %}
        setInterval(function() {
            // Optional: Add real-time updates
        }, 30000);
        {% endif %}
    </script>
</body>
</html>